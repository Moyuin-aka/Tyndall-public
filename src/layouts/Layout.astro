---
import GlobalStyles from "@components/GlobalStyles.astro";
import { ViewTransitions } from "astro:transitions";
import "@styles/fonts.css";

interface Props {
  title: string;
  translationKey?: string;
}

import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";

const { title, translationKey } = Astro.props;

// 检测是否为 Safari（服务端无法判断，需要客户端处理）
// 我们在客户端禁用 Safari 的 View Transitions
---

<!doctype html>
<html lang={Astro.currentLocale}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>{title}</title>

    <!-- Critical: Inline minimal theme script to prevent FOUC -->
    <script>
      // 极简主题初始化（同步执行，防止闪烁）
      (function () {
        try {
          var mode = localStorage.getItem("theme-mode");
          var isDark =
            mode === "dark" ||
            (!mode &&
              window.matchMedia("(prefers-color-scheme: dark)").matches);

          if (isDark) {
            document.documentElement.classList.add("dark");
            document.documentElement.classList.remove("light-forced");
          } else if (mode === "light") {
            // 用户明确选择了 light 模式，添加 light-forced 类来覆盖媒体查询
            document.documentElement.classList.add("light-forced");
            document.documentElement.classList.remove("dark");
          }
        } catch (e) {}
      })();
    </script>

    <!-- Favicons and PWA manifest -->
    <link rel="icon" href="/favicon_io/favicon.ico" sizes="any" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon_io/favicon-32x32.png"
    />
    <link rel="apple-touch-icon" href="/favicon_io/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />

    <!-- RSS Feed -->
    {
      Astro.currentLocale === "en" ? (
        <link
          rel="alternate"
          type="application/rss+xml"
          title="Moyuin's Blog RSS Feed"
          href="/en/rss.xml"
        />
      ) : (
        <link
          rel="alternate"
          type="application/rss+xml"
          title="Moyuin 的博客 RSS Feed"
          href="/rss.xml"
        />
      )
    }

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />

    <!-- Critical CSS -->
    <GlobalStyles />

    <!-- Optimized font loading: combined request, reduced font weights -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@300;400;500;600;700&display=swap"
      media="print"
      onload="this.media='all'; this.onload=null;"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@300;400;500;600;700&display=swap"
      />
    </noscript>

    <!-- instant.page: 鼠标悬停 65ms 即开始预加载，实现瞬间切换 -->
    <script src="https://instant.page/5.2.0" type="module" defer></script>

    <!-- 资源状态管理 -->
    <script>
      // 简化的资源管理，避免与按需加载冲突
      if (typeof window !== "undefined") {
        import("@utils/smart-preload").catch(() => {
          // 静默失败，不影响主要功能
        });
      }
    </script>
  </head>
  <body class="has-header">
    <Header translationKey={translationKey} />
    <slot />
    <Footer />
    <script
      defer
      src="https://umami.moyuin.top/script.js"
      data-website-id="06448a1e-4437-4ab7-8f41-ecfd6ba7aace"></script>

    <!-- Smooth page transitions with built-in animations -->
    <ViewTransitions />

    <!-- 优化 ViewTransitions 的过渡效果 -->
    <style is:global>
      /* 更丝滑的页面切换动画 */
      @media (prefers-reduced-motion: no-preference) {
        ::view-transition-old(root),
        ::view-transition-new(root) {
          animation-duration: 0.35s;
          animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
      }

      /* 旧页面：淡出 + 轻微缩小 */
      ::view-transition-old(root) {
        animation-name: page-fade-out;
      }

      /* 新页面：淡入 + 轻微放大进入 */
      ::view-transition-new(root) {
        animation-name: page-fade-in;
      }

      @keyframes page-fade-out {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      @keyframes page-fade-in {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      /* 保持 Header 在过渡期间稳定 */
      [transition\:persist] {
        view-transition-name: persist-header;
      }

      ::view-transition-old(persist-header),
      ::view-transition-new(persist-header) {
        animation: none;
        mix-blend-mode: normal;
      }
    </style>

    <!-- Deferred theme logic - non-blocking -->
    <script>
      const isSafari = /^((?!chrome|android).)*safari/i.test(
        navigator.userAgent,
      );

      function handleThemeLoaded() {
        document.body.classList.add("theme-loaded", "lang-loaded");
      }

      document.addEventListener("DOMContentLoaded", handleThemeLoaded);

      document.addEventListener("astro:before-swap", (e) => {
        const mode = localStorage.getItem("theme-mode");
        const isDark =
          mode === "dark" ||
          (!mode && window.matchMedia("(prefers-color-scheme: dark)").matches);

        if (isDark) {
          e.newDocument.documentElement.classList.add("dark");
        }

        if (isSafari) {
          document.documentElement.classList.add("no-transition");
          e.newDocument.documentElement.classList.add("no-transition");
        }
      });

      document.addEventListener("astro:after-swap", () => {
        handleThemeLoaded();

        if (isSafari) {
          setTimeout(() => {
            document.documentElement.classList.remove("no-transition");
          }, 30);
        }
      });
    </script>

    <!-- Service Worker registration for performance caching -->
    <script>
      // Register Service Worker for caching static assets
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              setInterval(
                () => {
                  registration.update();
                },
                60 * 60 * 1000,
              );
            })
            .catch((error) => {});
        });
      }
    </script>
  </body>
</html>
