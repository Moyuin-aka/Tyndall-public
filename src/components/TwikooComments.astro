<div id="tcomment"></div>

<style is:global>
  /* Twikoo 评论区样式重写：保留原版风格，修复回复错位，优化视觉协调性 */

  /* --- 输入框高度保持 --- */
  .tk-input .el-textarea__inner {
    height: 130px !important;
  }
  .tk-input .el-textarea__inner:focus {
    background-image: none !important;
  }
  
  /* --- 回复气泡不要贴左边，维持默认缩进结构 --- */
  .tk-replies {
    left: 0 !important;
    width: 100% !important;
  }
  .tk-comments-container .tk-submit {
    left: 0 !important;
  }
  
  /* --- 回复文本不贴主评论头像 --- */
  .tk-replies .tk-avatar,
  .tk-replies .tk-avatar img {
    width: 2.5rem !important;
    height: 2.5rem !important;
  }
  
  /* --- 图片、代码框自适应修复 --- */
  .tk-content img {
    max-width: 100% !important;
  }
  .tk-content pre {
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  /* --- 鼠标悬停时显示设备信息（保留该功能）--- */
  .tk-extras {
    opacity: 0;
    transition: opacity 0.3s;
  }
  .tk-row:hover .tk-extras {
    opacity: 1;
  }
  
  /* 设备名称常态隐藏，悬停评论时显示 */
  .tk-extras {
    opacity: 0;
    -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
    filter: alpha(opacity=0);
  }
  .tk-content:hover + .tk-extras {
    -webkit-animation: tk-extras-fadeIn 0.5s linear;
    -moz-animation: tk-extras-fadeIn 0.5s linear;
    -o-animation: tk-extras-fadeIn 0.5s linear;
    -ms-animation: tk-extras-fadeIn 0.5s linear;
    animation: tk-extras-fadeIn 0.5s linear;
    -webkit-animation-fill-mode: forwards;
    -moz-animation-fill-mode: forwards;
    -o-animation-fill-mode: forwards;
    -ms-animation-fill-mode: forwards;
    animation-fill-mode: forwards;
  }
  
  @-moz-keyframes tk-extras-fadeIn {
    from {
      opacity: 0;
      -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
      filter: alpha(opacity=0);
    }
    to {
      opacity: 1;
      -ms-filter: none;
      filter: none;
    }
  }
  @-webkit-keyframes tk-extras-fadeIn {
    from {
      opacity: 0;
      -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
      filter: alpha(opacity=0);
    }
    to {
      opacity: 1;
      -ms-filter: none;
      filter: none;
    }
  }
  @-o-keyframes tk-extras-fadeIn {
    from {
      opacity: 0;
      -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
      filter: alpha(opacity=0);
    }
    to {
      opacity: 1;
      -ms-filter: none;
      filter: none;
    }
  }
  @keyframes tk-extras-fadeIn {
    from {
      opacity: 0;
      -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
      filter: alpha(opacity=0);
    }
    to {
      opacity: 1;
      -ms-filter: none;
      filter: none;
    }
  }

  /* ====== 通用按钮紫色主题 ====== */

  /* 点赞 / 回复 / 图标按钮（白天模式） */
  .tk-action-icon, .tk-meta-action i, .el-icon, .el-button--text {
    color: #b497ff !important;
  }

  /* 鼠标悬浮时颜色加深 */
  .tk-action-icon:hover, .tk-meta-action i:hover, .el-icon:hover, .el-button--text:hover {
    color: #9b78f0 !important;
  }

  /* 黑夜模式下小图标改成深紫色 */
  [data-theme="dark"] .tk-action-icon,
  [data-theme="dark"] .tk-meta-action i,
  [data-theme="dark"] .el-icon,
  [data-theme="dark"] .el-button--text {
    color: #a683ff !important;
  }

  [data-theme="dark"] .tk-action-icon:hover,
  [data-theme="dark"] .tk-meta-action i:hover,
  [data-theme="dark"] .el-icon:hover,
  [data-theme="dark"] .el-button--text:hover {
    color: #c6a4ff !important;
  }
  
  /* 默认模式按钮样式 */
  .el-button--primary {
    background-color: #b497ff !important;
    border-color: #b497ff !important;
    color: white !important;
  }
  .el-button--primary:hover {
    background-color: #a07efc !important;
    border-color: #a07efc !important;
  }

  /* 黑夜模式按钮颜色 */
  [data-theme="dark"] .el-button--primary {
    background-color: #8a63cc !important;
    border-color: #8a63cc !important;
  }
  [data-theme="dark"] .el-button--primary:hover {
    background-color: #7a56b8 !important;
    border-color: #7a56b8 !important;
  }

  /* ====== 评论区链接样式 ====== */
  
  /* 评论内容中的链接 */
  .tk-content a,
  .tk-admin-config a {
    color: #b497ff !important;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .tk-content a:hover,
  .tk-admin-config a:hover {
    color: #9b78f0 !important;
    text-decoration: underline;
  }

  /* 黑夜模式下的链接 */
  [data-theme="dark"] .tk-content a,
  [data-theme="dark"] .tk-admin-config a {
    color: #c6a4ff !important;
  }

  [data-theme="dark"] .tk-content a:hover,
  [data-theme="dark"] .tk-admin-config a:hover {
    color: #ddbfff !important;
  }

  /* 访客信息链接（昵称、网站等） */
  .tk-nick a,
  .tk-action-count,
  .tk-link {
    color: #b497ff !important;
    text-decoration: none;
  }

  .tk-nick a:hover,
  .tk-action-count:hover,
  .tk-link:hover {
    color: #9b78f0 !important;
    text-decoration: underline;
  }

  [data-theme="dark"] .tk-nick a,
  [data-theme="dark"] .tk-action-count,
  [data-theme="dark"] .tk-link {
    color: #c6a4ff !important;
  }

  [data-theme="dark"] .tk-nick a:hover,
  [data-theme="dark"] .tk-action-count:hover,
  [data-theme="dark"] .tk-link:hover {
    color: #ddbfff !important;
  }
</style>

<script>
  (function() {
    const TWIKOO_JS_ID = 'twikoo-cdn-script';
    const TWIKOO_CDN = 'https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.js';
    const TWIKOO_CSS_ID = 'twikoo-cdn-style';
    const TWIKOO_CSS = 'https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.css';

    function loadScriptOnce() {
      if (window.twikoo) return Promise.resolve();
      if (document.getElementById(TWIKOO_JS_ID)) {
        // 等已存在的脚本加载完成后再继续
        return new Promise(resolve => {
          document.addEventListener('twikoo:ready', () => resolve(undefined), { once: true });
        });
      }
      return new Promise(resolve => {
        const s = document.createElement('script');
        s.src = TWIKOO_CDN;
        s.id = TWIKOO_JS_ID;
        s.defer = true;
        s.onload = () => {
          document.dispatchEvent(new CustomEvent('twikoo:ready'));
          resolve(undefined);
        };
        document.head.appendChild(s);
      });
    }

    function ensureCssOnce() {
      if (document.getElementById(TWIKOO_CSS_ID)) return;
      const l = document.createElement('link');
      l.id = TWIKOO_CSS_ID;
      l.rel = 'preload';
      l.as = 'style';
      l.href = TWIKOO_CSS;
      l.onload = function() { this.rel = 'stylesheet'; };
      document.head.appendChild(l);
      // noscript fallback for users without JS is not necessary here (component itself requires JS)
    }

    function initTwikoo() {
      const el = document.getElementById('tcomment');
      if (!el) return;
      // 清空避免重复挂载
      el.innerHTML = '';
      const lang = (document.documentElement.lang || 'zh').toLowerCase().startsWith('en') ? 'en' : 'zh-CN';
      window.twikoo.init({
        envId: 'https://api.moyuin.top/twikoo', // server 模式：传入服务地址
        el: '#tcomment',
        path: location.pathname,
        lang,
      });
    }

    function ensureAndInit() {
      ensureCssOnce();
      loadScriptOnce().then(() => {
        if (window.twikoo) initTwikoo();
      });
    }

    document.addEventListener('DOMContentLoaded', ensureAndInit);
    document.addEventListener('astro:page-load', ensureAndInit);
  })();
</script>
