---
import { useTranslations } from '@utils/ui';
import { getCollection } from 'astro:content';
import Layout from '@layouts/Layout.astro';

const t = useTranslations(Astro.currentLocale);
const locale = Astro.currentLocale;

const all = await getCollection('blog', ({ data }) => {
  // åªåŒ…å«å·²å‘å¸ƒçš„æ–‡ç« 
  return data.published !== false;
});

// å»é‡å‡½æ•°ï¼šæŒ‰ translationKey å»é‡
function stripLangPrefix(slug: string) { return slug.replace(/^en\//,''); }
function getUniqueKey(post: any) {
  return post.data.translationKey || stripLangPrefix(post.slug);
}

// ç»Ÿè®¡æ¯ä¸ªåˆ†ç±»çš„æ–‡ç« æ•°é‡ï¼ˆæŒ‰ translationKey å»é‡ï¼‰
const categoryCount = new Map<string, number>();
const categoryPosts = new Map<string, any[]>();
const categoryUniqueKeys = new Map<string, Set<string>>(); // è®°å½•æ¯ä¸ªåˆ†ç±»çš„å”¯ä¸€æ–‡ç« key

for (const post of all) {
  const category = post.data.category || 'uncategorized';
  const uniqueKey = getUniqueKey(post);
  
  if (!categoryUniqueKeys.has(category)) {
    categoryUniqueKeys.set(category, new Set());
  }
  
  // åªæœ‰æ–°çš„æ–‡ç« æ‰è®¡æ•°
  if (!categoryUniqueKeys.get(category)!.has(uniqueKey)) {
    categoryUniqueKeys.get(category)!.add(uniqueKey);
  }
  
  if (!categoryPosts.has(category)) {
    categoryPosts.set(category, []);
  }
  categoryPosts.get(category)!.push(post);
}

// ä½¿ç”¨å»é‡åçš„æ•°é‡
for (const [category, keys] of categoryUniqueKeys) {
  categoryCount.set(category, keys.size);
}

// æŒ‰æ–‡ç« æ•°é‡é™åºæ’åº
const sortedCategories = Array.from(categoryCount.entries())
  .sort((a, b) => b[1] - a[1]);

// åˆ†ç±»çš„ä¸­è‹±æ–‡æ˜ å°„
const categoryNames: Record<string, { zh: string; en: string }> = {
  'ctf': { zh: 'CTF', en: 'CTF' },
  'notes': { zh: 'ç¬”è®°', en: 'Notes' },
  'record': { zh: 'è®°å½•', en: 'Records' },
  'thoughts': { zh: 'éšç¬”', en: 'Thoughts' },
  'weekly': { zh: 'å‘¨è®°', en: 'Weekly' },
  'tech': { zh: 'æŠ€æœ¯', en: 'Tech' },
  'life': { zh: 'ç”Ÿæ´»', en: 'Life' },
  'uncategorized': { zh: 'æœªåˆ†ç±»', en: 'Uncategorized' },
};

function getCategoryDisplayName(category: string) {
  return categoryNames[category]?.[locale as 'zh' | 'en'] || category;
}
---
<Layout title={t('categories_page_title')}>
  <main class="categories-container">
    <header class="categories-hero">
      <p class="categories-hero-subtitle">{t('categories_hero_subtitle')}</p>
      <h1 class="categories-hero-slogan">{t('categories_hero_slogan')}</h1>
    </header>

    <section class="categories-grid">
      {sortedCategories.map(([category, count]) => (
        <a href={locale === 'zh' ? `/category/${category}` : `/en/category/${category}`} class="category-card">
          <div class="category-icon">
            {category === 'ctf' && 'ğŸš©'}
            {category === 'notes' && 'ğŸ“'}
            {category === 'record' && 'ğŸ“–'}
            {category === 'thoughts' && 'ğŸ’­'}
            {category === 'weekly' && 'ğŸ“…'}
            {category === 'tech' && 'ğŸ’»'}
            {category === 'life' && 'ğŸŒ±'}
            {category === 'uncategorized' && 'ğŸ“¦'}
          </div>
          <h2 class="category-name">{getCategoryDisplayName(category)}</h2>
          <p class="category-count">
            {count} {t('category_posts_count')}
          </p>
        </a>
      ))}
    </section>
  </main>
</Layout>

<style>
  .categories-container {
    font-family: var(--font-sans);
    max-width: 1000px;
    margin: 5rem auto 2rem;
    padding: 20px;
  }

  .categories-hero {
    text-align: center;
    margin-bottom: 4rem;
  }

  .categories-hero-subtitle {
    font-family: var(--font-serif);
    font-size: 0.9rem;
    letter-spacing: 0.1em;
    color: var(--grey);
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  .categories-hero-slogan {
    font-family: var(--font-serif);
    font-size: 3rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1.2;
  }

  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-top: 3rem;
  }

  .category-card {
    background: var(--background);
    border: 1px solid rgba(162, 89, 236, 0.2);
    border-radius: 12px;
    padding: 2rem 1.5rem;
    text-align: center;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .category-card:hover {
    border-color: var(--purple);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(162, 89, 236, 0.15);
  }

  .category-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .category-name {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--text);
    margin-bottom: 0.5rem;
  }

  .category-count {
    font-size: 0.9rem;
    color: var(--grey);
  }

  @media (max-width: 768px) {
    .categories-hero-slogan {
      font-size: 2.5rem;
    }

    .categories-grid {
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
    }

    .category-card {
      padding: 1.5rem 1rem;
    }

    .category-icon {
      font-size: 2.5rem;
    }

    .category-name {
      font-size: 1.25rem;
    }
  }
</style>
