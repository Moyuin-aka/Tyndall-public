---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import '@styles/markdown.css';
import { useTranslations } from '@utils/ui';
import TwikooComments from '@components/TwikooComments.astro';
import TableOfContents from '@components/TableOfContents.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => {
    // Âè™ÂåÖÂê´Â∑≤ÂèëÂ∏ÉÁöÑÊñáÁ´†
    return data.published !== false;
  });
  const paths = [];
  
  // ‰∏∫ÊØè‰∏™ translationKey ÁîüÊàêËã±ÊñáË∑ØÂæÑ
  const keySet = new Set();
  for (const post of allPosts) {
    const key = post.data.translationKey ?? post.slug.replace(/^en\//, '');
    if (!keySet.has(key)) {
      keySet.add(key);
      paths.push({
        params: { slug: key },
        props: { translationKey: key },
      });
    }
  }
  
  return paths;
}

const { translationKey } = Astro.props;
const t = useTranslations(Astro.currentLocale);
const locale = Astro.currentLocale;

// Êü•ÊâæÂΩìÂâçËØ≠Ë®ÄÁöÑÊñáÁ´†ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÂõûÈÄÄÂà∞ÂÖ∂‰ªñËØ≠Ë®Ä
const allPosts = await getCollection('blog', ({ data }) => {
  // Âè™ÂåÖÂê´Â∑≤ÂèëÂ∏ÉÁöÑÊñáÁ´†
  return data.published !== false;
});
const currentLangPost = allPosts.find(p => 
  (p.data.translationKey ?? p.slug.replace(/^en\//, '')) === translationKey && 
  p.data.lang === locale
);

const fallbackPost = allPosts.find(p => 
  (p.data.translationKey ?? p.slug.replace(/^en\//, '')) === translationKey
);

const post = currentLangPost || fallbackPost;
const isFallback = !currentLangPost && !!fallbackPost;

if (!post) {
  throw new Error(`Post not found: ${translationKey}`);
}

const { Content, headings } = await post.render();
---
<Layout title={post.data.title} translationKey={translationKey}>
  <main class="post-container">
    <h1>{post.data.title}</h1>
    
    {isFallback && (
      <div class="fallback-tip">
        {t('post_not_translated')}
      </div>
    )}
    
    <p class="post-date">
      {post.data.pubDate.toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' })}
    </p>
    
    <TableOfContents headings={headings} />
    
    <div class="markdown-content">
      <Content />
    </div>
    
    <hr class="comment-divider" />
    
    <TwikooComments />
  </main>
</Layout>

<script is:inline>
  // ÂÜÖËÅîÂä†ËΩΩ MermaidÔºåÁ°Æ‰øùÂú®È°µÈù¢Âä†ËΩΩÂêéÊâßË°å
  (async function() {
    let mermaidModule = null;
    
    async function initMermaid() {
      try {
        //console.log('üîç Starting Mermaid initialization...');
        
        if (!mermaidModule) {
          const module = await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs');
          mermaidModule = module.default;
          //console.log('‚úÖ Mermaid module loaded');
        }
        
        const isDark = document.documentElement.classList.contains('dark');
        
        mermaidModule.initialize({
          startOnLoad: false,
          theme: isDark ? 'dark' : 'default',
          securityLevel: 'loose',
        });
        
        // Astro uses data-language attribute instead of class
        const mermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"]');
        
        if (mermaidBlocks.length === 0) {
          return;
        }
        
        for (const pre of mermaidBlocks) {
          const code = pre.querySelector('code');
          if (!code) continue;
          
          const div = document.createElement('div');
          div.className = 'mermaid-diagram';
          // Get plain text content (removing HTML tags added by Shiki)
          div.textContent = code.textContent || '';
          div.style.textAlign = 'center';
          div.style.margin = '2em 0';
          
          pre.replaceWith(div);
        }
        
        await mermaidModule.run({
          querySelector: '.mermaid-diagram',
        });
      } catch (error) {
        //console.error('Failed to initialize Mermaid:', error);
      }
    }
    
    function onLoad() {
      setTimeout(initMermaid, 500);
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', onLoad);
    } else {
      onLoad();
    }
    
    document.addEventListener('astro:page-load', onLoad);
  })();
</script>

<style>
  .post-container {
    max-width: 800px;
    margin: 5rem auto 2rem;
    padding: 20px;
  }

  .post-container h1 {
    font-family: var(--font-serif);
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .post-date {
    font-family: var(--font-sans);
    color: var(--grey);
    margin-bottom: 2rem;
  }

  .fallback-tip {
    font-family: var(--font-sans);
    color: var(--grey);
    background: rgba(162, 89, 236, 0.1);
    border: 1px solid rgba(162, 89, 236, 0.25);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 1rem;
  }

  /* ËØÑËÆ∫Âå∫ÂàÜÈöîÁ∫ø */
  .comment-divider {
    margin: 3rem 0 2.5rem;
    border: none;
    border-top: 1px solid var(--grey);
    opacity: 0.3;
  }
</style>
