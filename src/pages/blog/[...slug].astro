---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import '@styles/markdown.css';
import { useTranslations } from '@utils/ui';
import TwikooComments from '@components/TwikooComments.astro';
import TableOfContents from '@components/TableOfContents.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => {
    // åªåŒ…å«å·²å‘å¸ƒçš„æ–‡ç« 
    return data.published !== false;
  });
  const paths = [];
  
  // ä¸ºæ¯ä¸ª translationKey ç”Ÿæˆä¸­æ–‡è·¯å¾„
  const keySet = new Set();
  for (const post of allPosts) {
    const key = post.data.translationKey ?? post.slug.replace(/^en\//, '');
    if (!keySet.has(key)) {
      keySet.add(key);
      paths.push({
        params: { slug: key },
        props: { translationKey: key },
      });
    }
  }
  
  return paths;
}

const { translationKey } = Astro.props;
const t = useTranslations(Astro.currentLocale);
const locale = Astro.currentLocale;

// æŸ¥æ‰¾å½“å‰è¯­è¨€çš„æ–‡ç« ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ°å…¶ä»–è¯­è¨€
const allPosts = await getCollection('blog', ({ data }) => {
  // åªåŒ…å«å·²å‘å¸ƒçš„æ–‡ç« 
  return data.published !== false;
});
const currentLangPost = allPosts.find(p => 
  (p.data.translationKey ?? p.slug.replace(/^en\//, '')) === translationKey && 
  p.data.lang === locale
);

const fallbackPost = allPosts.find(p => 
  (p.data.translationKey ?? p.slug.replace(/^en\//, '')) === translationKey
);

const post = currentLangPost || fallbackPost;
const isFallback = !currentLangPost && !!fallbackPost;

if (!post) {
  throw new Error(`Post not found: ${translationKey}`);
}

const { Content, headings } = await post.render();
---
<Layout title={post.data.title} translationKey={translationKey}>
  <main class="post-container">
    <h1>{post.data.title}</h1>
    
    {isFallback && (
      <div class="fallback-tip">
        {t('post_not_translated')}
      </div>
    )}
    
    <p class="post-date">
      {post.data.pubDate.toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' })}
    </p>
    
    <TableOfContents headings={headings} />
    
    <div class="markdown-content">
      <Content />
    </div>
    
    <hr class="comment-divider" />
    
    <TwikooComments />
  </main>
</Layout>

<script is:inline>
  // å†…è”åŠ è½½ Mermaidï¼Œç¡®ä¿åœ¨é¡µé¢åŠ è½½åæ‰§è¡Œ
  (async function() {
    let mermaidModule = null;
    
    async function initMermaid() {
      try {
        //console.log('ğŸ” Starting Mermaid initialization...');
        
        if (!mermaidModule) {
          const module = await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs');
          mermaidModule = module.default;
          //console.log('âœ… Mermaid module loaded');
        }
        
        const isDark = document.documentElement.classList.contains('dark');
        
        mermaidModule.initialize({
          startOnLoad: false,
          theme: isDark ? 'dark' : 'default',
          securityLevel: 'loose',
        });
        
        // Astro ä½¿ç”¨ data-language å±æ€§è€Œä¸æ˜¯ class
        const mermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"]');
        
        if (mermaidBlocks.length === 0) {
          return;
        }
        
        for (const pre of mermaidBlocks) {
          const code = pre.querySelector('code');
          if (!code) continue;
          
          const div = document.createElement('div');
          div.className = 'mermaid-diagram';
          // è·å–çº¯æ–‡æœ¬å†…å®¹ï¼ˆå»é™¤ Shiki æ·»åŠ çš„ HTML æ ‡ç­¾ï¼‰
          div.textContent = code.textContent || '';
          div.style.textAlign = 'center';
          div.style.margin = '2em 0';
          
          pre.replaceWith(div);
        }
        
        await mermaidModule.run({
          querySelector: '.mermaid-diagram',
        });
      } catch (error) {
        console.error('Failed to initialize Mermaid:', error);
      }
    }
    
    function onLoad() {
      setTimeout(initMermaid, 500);
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', onLoad);
    } else {
      onLoad();
    }
    
    document.addEventListener('astro:page-load', onLoad);
  })();
</script>

<script is:inline>
  // ä¸ºè¡¨æ ¼æ·»åŠ æ»šåŠ¨å®¹å™¨åŒ…è£…å™¨
  function wrapTables() {
    const tables = document.querySelectorAll('.markdown-content table');
    tables.forEach(table => {
      // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«åŒ…è£…è¿‡
      if (table.parentElement.classList.contains('table-wrapper')) {
        return;
      }
      
      const wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      table.parentNode.insertBefore(wrapper, table);
      wrapper.appendChild(table);
    });
  }
  
  // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', wrapTables);
  } else {
    wrapTables();
  }
  
  // Astro è·¯ç”±åˆ‡æ¢æ—¶æ‰§è¡Œ
  document.addEventListener('astro:page-load', wrapTables);
</script>

<style>
  .post-container {
    max-width: 800px;
    margin: 5rem auto 2rem;
    padding: 20px;
    width: 100%;
    /* ä¸è®¾ç½® overflowï¼Œè®©å­å…ƒç´ è‡ªå·±å¤„ç† */
    /* ä½¿ç”¨ box-sizing ç¡®ä¿ padding ä¸ä¼šå¢åŠ æ€»å®½åº¦ */
    box-sizing: border-box;
  }
  
  /* markdown å†…å®¹å®¹å™¨ */
  .markdown-content {
    /* é™åˆ¶å†…å®¹æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æ’‘å¼€ */
    max-width: 100%;
    overflow-wrap: break-word;
    word-wrap: break-word;
  }

  .post-container h1 {
    font-family: var(--font-serif);
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    /* é•¿æ ‡é¢˜è‡ªåŠ¨æ¢è¡Œ */
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .post-date {
    font-family: var(--font-sans);
    color: var(--grey);
    margin-bottom: 2rem;
  }

  .fallback-tip {
    font-family: var(--font-sans);
    color: var(--grey);
    background: rgba(162, 89, 236, 0.1);
    border: 1px solid rgba(162, 89, 236, 0.25);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 1rem;
  }

  /* è¯„è®ºåŒºåˆ†éš”çº¿ */
  .comment-divider {
    margin: 3rem 0 2.5rem;
    border: none;
    border-top: 1px solid var(--grey);
    opacity: 0.3;
  }

  /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
  @media (max-width: 768px) {
    .post-container {
      padding: 15px;
      margin: 4rem auto 1.5rem;
    }

    .post-container h1 {
      font-size: 2rem;
    }
  }
</style>
